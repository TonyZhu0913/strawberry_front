<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI å‰©é£Ÿé æ¸¬å¸« - çœŸå¯¦æ•¸æ“šä¸²æ¥ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        
        <!-- æ¨™é¡Œå€ -->
        <header class="mb-8 text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2 flex items-center justify-center gap-3">
                <i data-lucide="database" class="text-blue-600 w-8 h-8"></i>
                AI å‰©é£Ÿé æ¸¬å¸« <span class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded-full align-middle">çœŸå¯¦æ•¸æ“šç‰ˆ</span>
            </h1>
            <p class="text-gray-500">åŸºæ–¼ XGBoost æ¨¡å‹èˆ‡æ­·å²éŠ·å”®æ•¸æ“šé©…å‹•</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- å·¦å´ï¼šè¼¸å…¥æ§åˆ¶å€ (Input) -->
            <div class="lg:col-span-3 space-y-6">
                <div class="bg-white p-6 rounded-xl shadow-md border-l-4 border-blue-500 sticky top-4">
                    <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <i data-lucide="sliders" class="w-5 h-5"></i>
                        é æ¸¬åƒæ•¸è¨­å®š
                    </h2>

                    <!-- è¼¸å…¥è®Šæ•¸ï¼šå°æ‡‰ Python æ¨¡å‹çš„ Features -->
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">é¸æ“‡æ—¥æœŸ (Date)</label>
                            <input type="date" id="dateInput" value="2013-01-02" class="w-full p-2 border rounded-lg bg-gray-50 outline-none focus:ring-2 focus:ring-blue-400">
                            <p class="text-xs text-gray-400 mt-1">æ¨¡å‹å°‡è‡ªå‹•æå–å¹´ä»½ã€æœˆä»½ã€æ˜ŸæœŸå¹¾</p>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">å•†åº—ç·¨è™Ÿ (Store ID)</label>
                            <select id="storeInput" class="w-full p-2 border rounded-lg bg-gray-50 outline-none">
                                <option value="1">Store 1 (å¸‚ä¸­å¿ƒ)</option>
                                <option value="2">Store 2 (éƒŠå€)</option>
                                <option value="3">Store 3 (å•†æ¥­å€)</option>
                            </select>
                        </div>
                    </div>

                    <hr class="border-gray-200 my-4">

                    <!-- åº«å­˜è¨­å®šæŒ‰éˆ• (æ–°å¢åŠŸèƒ½) -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">åº«å­˜ç®¡ç†</label>
                        <button onclick="openInventoryModal()" class="w-full bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-bold py-2 px-4 rounded-lg transition-all flex items-center justify-center gap-2 shadow-sm">
                            <i data-lucide="package" class="w-4 h-4"></i>
                            è¨­å®šåˆå§‹åº«å­˜
                        </button>
                    </div>

                    <hr class="border-gray-200 my-4">

                    <!-- å•†æ¥­ç­–ç•¥ -->
                    <div class="bg-indigo-50 p-4 rounded-lg border border-indigo-100 mb-4">
                        <label class="flex items-center gap-3 cursor-pointer mb-2">
                            <div class="relative">
                                <input type="checkbox" id="promoInput" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-500"></div>
                            </div>
                            <span class="text-sm font-bold text-indigo-900">å•Ÿç”¨ä¿ƒéŠ·æ´»å‹•</span>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <div class="relative">
                                <input type="checkbox" id="aiStrategyInput" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-indigo-600"></div>
                            </div>
                            <span class="text-sm font-bold text-indigo-900">å•Ÿç”¨å‹•æ…‹å®šåƒ¹ (AI)</span>
                        </label>
                    </div>

                    <button onclick="runRealSimulation()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition-all flex items-center justify-center gap-2 shadow-lg">
                        <i data-lucide="zap" class="w-5 h-5"></i>
                        å‘¼å« Python API
                    </button>
                    
                    <!-- ç‹€æ…‹é¡¯ç¤º -->
                    <div id="apiStatus" class="mt-4 text-center text-xs text-gray-400 font-mono">
                        Ready to connect...
                    </div>
                </div>
            </div>

            <!-- å³å´ï¼šå•†æ¥­å„€è¡¨æ¿ (Output) -->
            <div class="lg:col-span-9 space-y-6">
                
                <!-- KPI å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                        <div class="p-3 bg-green-100 rounded-full text-green-600"><i data-lucide="dollar-sign" class="w-8 h-8"></i></div>
                        <div><p class="text-sm text-gray-500 font-medium">é ä¼°ä»Šæ—¥ç‡Ÿæ”¶</p><h3 class="text-2xl font-bold text-gray-800" id="totalRevenueDisplay">NT$ 0</h3></div>
                    </div>
                    <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex items-center gap-4">
                        <div class="p-3 bg-red-100 rounded-full text-red-600"><i data-lucide="alert-triangle" class="w-8 h-8"></i></div>
                        <div><p class="text-sm text-gray-500 font-medium">æ½›åœ¨æµªè²»é‡‘é¡</p><h3 class="text-2xl font-bold text-red-600" id="totalLossDisplay">NT$ 0</h3></div>
                    </div>
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-5 rounded-xl shadow-md text-white flex items-center gap-4 opacity-50 transition-opacity duration-300" id="aiBenefitCard">
                        <div class="p-3 bg-white/20 rounded-full"><i data-lucide="sparkles" class="w-8 h-8"></i></div>
                        <div><p class="text-sm text-indigo-100 font-medium">AI ç­–ç•¥æŒ½å›æ”¶ç›Š</p><h3 class="text-2xl font-bold" id="recoveredRevenueDisplay">NT$ 0</h3></div>
                    </div>
                </div>

                <!-- æ•¸æ“šè¡¨æ ¼ -->
                <div class="bg-white rounded-xl shadow-md overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                        <h3 class="font-bold text-gray-700 flex items-center gap-2">
                            <i data-lucide="bar-chart-2" class="w-4 h-4"></i> å³æ™‚é æ¸¬çµæœ
                        </h3>
                        <span id="dateDisplay" class="text-xs font-mono bg-blue-100 text-blue-700 px-2 py-1 rounded">2013-01-02</span>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table class="w-full text-left text-sm">
                            <thead>
                                <tr class="bg-gray-100 text-gray-600 uppercase tracking-wider font-semibold">
                                    <th class="p-4">å•†å“é¡åˆ¥ (Family)</th>
                                    <th class="p-4 text-right">å–®åƒ¹</th>
                                    <th class="p-4 text-center">ç›®å‰åº«å­˜</th>
                                    <th class="p-4 text-center bg-blue-50 text-blue-800">AI é æ¸¬éŠ·é‡</th>
                                    <th class="p-4 text-center">æ±ºç­–å»ºè­°</th>
                                    <th class="p-4 text-right">é ä¼°ç‡Ÿæ”¶</th>
                                    <th class="p-4 text-right">å‰©é£Ÿé¢¨éšª</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-100 text-gray-700">
                                <tr><td colspan="7" class="p-8 text-center text-gray-400">è«‹è¨­å®šåƒæ•¸ä¸¦é»æ“ŠæŒ‰éˆ•...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- åº«å­˜è¨­å®š Modal -->
    <div id="inventoryModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl w-full max-w-lg p-6 m-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                    <i data-lucide="package" class="w-5 h-5 text-blue-600"></i>
                    è¨­å®šåˆå§‹åº«å­˜
                </h3>
                <button onclick="closeInventoryModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div id="inventoryInputs" class="space-y-4">
                <!-- Javascript å°‡è‡ªå‹•ç”Ÿæˆè¼¸å…¥æ¬„ä½ -->
            </div>

            <div class="mt-8 flex gap-3">
                <button onclick="closeInventoryModal()" class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium">å–æ¶ˆ</button>
                <button onclick="saveInventory()" class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md">å„²å­˜è¨­å®š</button>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // 1. å‰ç«¯åº«å­˜æ¨¡æ“¬è³‡æ–™
        // æ³¨æ„ï¼šé€™è£¡çš„ keys è¦å°æ‡‰ app.py å›å‚³çš„ family åç¨±
        let inventoryDB = {
            'BREAD/BAKERY': { name: "ç”Ÿé®®çƒ˜ç„™ (éºµåŒ…)", stock: 150, price: 45, cost: 20 },
            'DELI':         { name: "å³é£Ÿç†Ÿé£Ÿ (Deli)", stock: 80,  price: 120, cost: 70 },
            'DAIRY':        { name: "ä¹³è£½å“ (ç‰›å¥¶)",   stock: 120, price: 90, cost: 60 },
            'EGGS':         { name: "ç”Ÿé®®é›è›‹",       stock: 100, price: 10, cost: 5 },
            'PRODUCE':      { name: "ç”Ÿé®®è”¬æœ",       stock: 200, price: 60, cost: 30 },
            'GROCERY I':    { name: "ç”Ÿé®®é›œè²¨",       stock: 200, price: 50, cost: 25 }
        };

        // --- åº«å­˜ Modal ç›¸é—œå‡½æ•¸ ---
        
        function openInventoryModal() {
            const container = document.getElementById('inventoryInputs');
            container.innerHTML = ''; // æ¸…ç©ºèˆŠå…§å®¹

            // å‹•æ…‹ç”Ÿæˆè¼¸å…¥æ¬„ä½
            for (const [key, item] of Object.entries(inventoryDB)) {
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-3 bg-gray-50 rounded-lg border border-gray-100";
                div.innerHTML = `
                    <div>
                        <div class="font-medium text-gray-800">${item.name}</div>
                        <div class="text-xs text-gray-400">${key}</div>
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="text-sm text-gray-500">æ•¸é‡:</span>
                        <input type="number" id="stock-${key}" value="${item.stock}" min="0" 
                               class="w-24 p-2 border rounded-md focus:ring-2 focus:ring-blue-500 outline-none text-right font-mono">
                    </div>
                `;
                container.appendChild(div);
            }

            document.getElementById('inventoryModal').classList.remove('hidden');
        }

        function closeInventoryModal() {
            document.getElementById('inventoryModal').classList.add('hidden');
        }

        function saveInventory() {
            // è®€å–è¼¸å…¥å€¼ä¸¦æ›´æ–° inventoryDB
            for (const key of Object.keys(inventoryDB)) {
                const input = document.getElementById(`stock-${key}`);
                if (input) {
                    const newStock = parseInt(input.value);
                    if (!isNaN(newStock) && newStock >= 0) {
                        inventoryDB[key].stock = newStock;
                    }
                }
            }
            
            closeInventoryModal();
            
            // å¦‚æœå·²ç¶“æœ‰é¡¯ç¤ºçµæœï¼Œé‡æ–°è¨ˆç®—ä¸¦æ¸²æŸ“ï¼ˆé¸æ“‡æ€§ï¼‰
            // é€™è£¡ç°¡å–®æç¤ºä½¿ç”¨è€…å„²å­˜æˆåŠŸ
            const btn = document.querySelector('button[onclick="openInventoryModal()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> å·²æ›´æ–°`;
            btn.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-green-50', 'text-green-700', 'border-green-200');
                lucide.createIcons();
            }, 1500);
        }

        // --- åŸæœ‰æ¨¡æ“¬å‡½æ•¸ ---

        async function runRealSimulation() {
            // å–å¾—è¼¸å…¥
            const date = document.getElementById('dateInput').value;
            const store = document.getElementById('storeInput').value;
            const hasPromo = document.getElementById('promoInput').checked;
            const useAIStrategy = document.getElementById('aiStrategyInput').checked;

            // UI ç‹€æ…‹æ›´æ–°
            document.getElementById('apiStatus').innerText = "Connecting to Python API...";
            document.getElementById('apiStatus').className = "mt-4 text-center text-xs text-blue-500 font-mono animate-pulse";
            document.getElementById('tableBody').innerHTML = '<tr><td colspan="7" class="p-8 text-center"><div class="animate-spin inline-block w-6 h-6 border-2 border-blue-500 border-t-transparent rounded-full"></div> AI æ­£åœ¨é‹ç®—ä¸­...</td></tr>';
            document.getElementById('dateDisplay').innerText = date;

            try {
                // 2. å‘¼å«çœŸå¯¦çš„ Python API
                const response = await fetch('https://testrailway-production-ca1c.up.railway.app/api/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        date: date,
                        store_nbr: store,
                        promo: hasPromo
                    })
                });

                if (!response.ok) throw new Error("API Connection Failed");
                const apiResult = await response.json();
                
                if (apiResult.status !== 'success') throw new Error(apiResult.message);

                // 3. è™•ç†å›å‚³è³‡æ–™ä¸¦çµåˆå‰ç«¯é‚è¼¯
                processResults(apiResult.predictions, useAIStrategy);
                
                document.getElementById('apiStatus').innerText = "Connected: 200 OK";
                document.getElementById('apiStatus').className = "mt-4 text-center text-xs text-green-500 font-mono";

            } catch (error) {
                console.error(error);
                document.getElementById('apiStatus').innerText = "Connection Error: è«‹ç¢ºèª app.py å·²åŸ·è¡Œ";
                document.getElementById('apiStatus').className = "mt-4 text-center text-xs text-red-500 font-bold";
                document.getElementById('tableBody').innerHTML = `<tr><td colspan="7" class="p-8 text-center text-red-500">ç„¡æ³•é€£ç·šåˆ°å¾Œç«¯ APIã€‚<br>è«‹ç¢ºä¿æ‚¨å·²åŸ·è¡Œ <code class="bg-gray-100 p-1 rounded">python app.py</code></td></tr>`;
            }
        }

        function processResults(predictions, useAIStrategy) {
            let totalRevenue = 0;
            let totalLoss = 0;
            let totalRecovered = 0;
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            predictions.forEach(pred => {
                // å–å¾—å°æ‡‰çš„å•†å“è³‡è¨Š
                const itemInfo = inventoryDB[pred.family];
                if (!itemInfo) return; // å¦‚æœå‰ç«¯è³‡æ–™åº«æ²’æœ‰é€™å€‹å•†å“ï¼Œè·³é

                // --- å•†æ¥­é‚è¼¯é‹ç®— (èˆ‡ä¹‹å‰çš„ demo é¡ä¼¼ï¼Œä½†æ•¸æ“šä¾†è‡ª API) ---
                let predictedSales = pred.prediction;
                let finalPrice = itemInfo.price;
                let finalSales = predictedSales;
                let action = "ç¶­æŒåŸåƒ¹";
                let actionClass = "bg-gray-100 text-gray-600";
                let recovered = 0;

                const potentialWaste = itemInfo.stock - predictedSales;

                // AI ç­–ç•¥ï¼šå¦‚æœé æ¸¬å‰©é¤˜å¤ªå¤šï¼Œè‡ªå‹•æ‰“æŠ˜
                if (useAIStrategy && potentialWaste > itemInfo.stock * 0.2) {
                    finalPrice = Math.round(itemInfo.price * 0.7); // æ‰“7æŠ˜
                    // åƒ¹æ ¼å½ˆæ€§å‡è¨­ï¼šé™åƒ¹æœƒåˆºæ¿€éŠ·é‡
                    const stimulus = (itemInfo.stock - predictedSales) * 0.8; 
                    finalSales += stimulus;
                    if (finalSales > itemInfo.stock) finalSales = itemInfo.stock;

                    action = `ğŸ“‰ é™åƒ¹ä¿ƒéŠ· ($${finalPrice})`;
                    actionClass = "bg-indigo-100 text-indigo-700 font-bold border border-indigo-200";
                    
                    // æŒ½å›æ”¶ç›Šï¼šé¡å¤–è³£å‡ºçš„é‡ * æ‰“æŠ˜å¾Œçš„åƒ¹æ ¼
                    recovered = (finalSales - predictedSales) * finalPrice;
                } else if (potentialWaste < 0) {
                    action = "âš ï¸ éœ€è£œè²¨";
                    actionClass = "bg-blue-100 text-blue-700";
                    finalSales = itemInfo.stock;
                }

                finalSales = Math.floor(finalSales);
                const waste = Math.max(0, itemInfo.stock - finalSales);
                const revenue = finalSales * finalPrice;
                const loss = waste * itemInfo.cost;

                totalRevenue += revenue;
                totalLoss += loss;
                totalRecovered += Math.max(0, recovered);

                // æ¸²æŸ“è¡¨æ ¼åˆ—
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition-colors border-b last:border-0 fade-in";
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-medium text-gray-800">${itemInfo.name}</div>
                        <div class="text-xs text-gray-400">${pred.family}</div>
                    </td>
                    <td class="p-4 text-right text-gray-500">$${itemInfo.price}</td>
                    <td class="p-4 text-center text-gray-500">${itemInfo.stock}</td>
                    <td class="p-4 text-center font-bold text-blue-600">${Math.round(pred.prediction)}</td>
                    <td class="p-4 text-center"><span class="px-2 py-1 rounded-md text-xs ${actionClass}">${action}</span></td>
                    <td class="p-4 text-right font-mono font-bold text-gray-700">$${revenue.toLocaleString()}</td>
                    <td class="p-4 text-right">
                        ${waste > 0 ? `<span class="text-red-500 font-bold">${waste}</span>` : '<span class="text-gray-300">-</span>'}
                    </td>
                `;
                tbody.appendChild(tr);
            });

            updateCards(totalRevenue, totalLoss, totalRecovered, useAIStrategy);
        }

        function updateCards(revenue, loss, recovered, aiActive) {
            // ä½¿ç”¨ animateValue å–ä»£åŸæœ¬çš„ç›´æ¥è³¦å€¼
            animateValue("totalRevenueDisplay", Math.round(revenue));
            animateValue("totalLossDisplay", Math.round(loss));
            animateValue("recoveredRevenueDisplay", Math.round(recovered));

            const aiCard = document.getElementById('aiBenefitCard');
            if (aiActive) {
                aiCard.classList.remove('opacity-50');
                aiCard.classList.add('ring-4', 'ring-indigo-200');
            } else {
                aiCard.classList.add('opacity-50');
                aiCard.classList.remove('ring-4', 'ring-indigo-200');
            }
        }

        // æ–°å¢çš„æ•¸å€¼è·³å‹•å‹•ç•«å‡½æ•¸
        function animateValue(id, end) {
            const obj = document.getElementById(id);
            // æŠ“å–ç›®å‰çš„æ•¸å€¼ï¼ˆç§»é™¤éæ•¸å­—å­—å…ƒï¼‰ï¼Œè‹¥ç„¡å‰‡ç‚º 0
            const start = parseInt(obj.innerText.replace(/[^0-9-]/g, '')) || 0;
            if (start === end) return;
            
            let current = start;
            // è¨ˆç®—æ¯æ¬¡è·³å‹•çš„æ­¥é•·ï¼Œåˆ† 20 æ­¥å®Œæˆ
            const step = end > start ? Math.ceil((end - start) / 20) : Math.floor((end - start) / 20);
            
            const timer = setInterval(() => {
                current += step;
                // åˆ¤æ–·æ˜¯å¦åˆ°é”æˆ–è¶…éç›®æ¨™å€¼
                if ((step > 0 && current >= end) || (step < 0 && current <= end)) {
                    current = end;
                    clearInterval(timer);
                }
                obj.innerText = "NT$ " + current.toLocaleString();
            }, 20);
        }
    </script>
</body>
</html>
